<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AGENTE</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <!-- jQuery, Popper.js, and Bootstrap 4 JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu8A+z3Fw3CAy5M0x1hBg27x6pEjjplrF1zGJXkYz0fB4xL4K" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B0UglyR+jNkl+PVRNtv+n64rYLD6KC8f2N5XgA2xDlCwl0Y5qepdElJ0y9P8C/Z9" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<!-- Bootstrap 5 CSS -->
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

</head>

<body>

  <div class="dashboard-wrapper">
    <!-- SIDEBAR -->
  <aside class="sidebar">
  <div class="logo">🏠 AGENTE </div>
  <nav class="menu">
    <a href="#" id="link-dashboard">Dashboard</a>
    <a href="#" id="link-propiedades">Propiedades</a>
    <a href="#" id="link-visitas">Visitas</a>
    <a href="#" id="link-contratos">Contratos</a>
    <a href="#" onclick="cerrarSesion()">Cerrar sesión</a>
  </nav>
</aside>


<!-- CONTENIDO PRINCIPAL -->
<main class="main-content">
  <header class="topbar">
    <div class="user-info">
      <div class="user-avatar">C</div>
      <div>
        <h2>Agente</h2>
        <p>agente@email.com | ID: CLI-001</p>
      </div>
    </div>
  </header>

  <!-- SECCIÓN: PROPIEDADES -->
   
  <section id="section-propiedades" class="section visible">
    <h3>Registrar Nueva Propiedad</h3>
 <form id="formPropiedad" enctype="multipart/form-data">
  <label>Dirección:</label>
  <input type="text" name="direccion" required>

  <label>Tipo:</label>
  <select name="tipo" required>
    <option value="">Selecciona</option>
    <option value="Casa">Casa</option>
    <option value="Departamento">Departamento</option>
  </select>

  <label>Precio (S/.):</label>
  <input type="number" name="precio" min="0" required>

  <label>Foto:</label>
  <input type="file" name="foto" accept="image/*">

  <button type="submit">Guardar Propiedad</button>
</form>


    <h3 style="margin-top: 30px;">Listado de Propiedades</h3>
    <table>
      <thead>
       
      </thead>
      <tbody>
      
      </tbody>
    </table>
<div id="propiedadesContainer"></div>

  </section>


   
 <section id="section-visitas" class="section hidden">
  <h3>Registrar Visita</h3>
 <form id="formVisita">
   <label>Cliente:</label>
  <input type="text" id="cliente" name="cliente" required>
   <label>Propiedad:</label>
  <input type="text" id="propiedad" name="propiedad" required>
   <label>Fecha:</label>
  <input type="date" id="fechaVisita" name="fechaVisita" required>
   <label>comentario:</label>
  <textarea id="comentario" name="comentario" required></textarea>
  <button type="submit">Guardar Visita</button>
</form>

   <h3 style="margin-top: 30px;">Listado de Visitas</h3>
  <div id="visitasContainer"></div>
</section>
<!-- SECCIÓN: VISITAS -->
<section id="section-visitas" class="section hidden">
  <h3>Registrar Visita</h3>
  <form id="formVisita">
    <div class="form-group">
      <label for="cliente">Cliente:</label>
      <input type="text" id="cliente" name="cliente" required placeholder="Nombre del cliente">
    </div>

    <div class="form-group">
      <label for="propiedad">Propiedad:</label>
      <input type="text" id="propiedad" name="propiedad" required placeholder="Dirección o referencia">
    </div>

    <div class="form-group">
      <label for="fechaVisita">Fecha de Visita:</label>
      <input type="date" id="fechaVisita" name="fechaVisita" required>
    </div>

    <div class="form-group">
      <label for="comentario">Comentario:</label>
      <textarea id="comentario" name="comentario" rows="3" required placeholder=""></textarea>
    </div>

    <button type="submit">Guardar Visita</button>
  </form>

  <!-- Contenedor para mostrar visitas guardadas -->
  <div id="visitasContainer" style="margin-top: 30px;"></div>
</section>


  <!-- SECCIÓN: CONTRATOS -->
  
<section id="section-contratos" class="section hidden">
  <h3>Registrar Contrato</h3>
  <form id="formContrato" class="mb-4">
  <div class="form-group">
    <label>Cliente:</label>
    <input type="text" id="clienteContrato" class="form-control" required>
  </div>
  <div class="form-group">
    <label>Propiedad:</label>
    <input type="text" id="propiedadContrato" class="form-control" required>
  </div>
  <div class="form-group">
    <label>Fecha de Firma:</label>
    <input type="date" id="fechaFirmaContrato" class="form-control" required>
  </div>
  <div class="form-group">
    <label>Duración (meses):</label>
    <input type="number" id="duracionContrato" class="form-control" required>
  </div>
  <button type="submit" class="btn btn-primary">Guardar Contrato</button>
</form>
<h4></h4>
<h3 style="margin-top: 40px;">Contratos Registrados</h3>
  
 <div class="container mt-4">
<div id="contratosContainer" class="row"></div>

    <!-- Aquí se agregan dinámicamente las tarjetas -->
  </div>
</div>

</section>

</main>



  
  </div>

  <script>
  // Mapeo de secciones según el texto del enlace
  const secciones = {
    "Dashboard": "section-propiedades",
    "Propiedades": "section-propiedades",
    "Visitas": "section-visitas",
    "Contratos": "section-contratos"
  };

  // Agrega el evento a todos los enlaces del menú
  document.querySelectorAll('.sidebar .menu a').forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();

      const texto = this.textContent.trim();

      // Si el enlace es "Cerrar sesión", no continuar
      if (texto === "Cerrar sesión") {
        cerrarSesion();
        return;
      }

      // Oculta todas las secciones
      document.querySelectorAll('main .section').forEach(sec => sec.classList.add('hidden'));

      // Muestra la sección correspondiente
      const idSeccion = secciones[texto];
      if (idSeccion) {
        document.getElementById(idSeccion).classList.remove('hidden');
      }
    });
  });

  // Función para cerrar sesión
  function cerrarSesion() {
    alert("Sesión cerrada (demo)");
    // Aquí podrías redirigir o limpiar datos del usuario
  }
</script>
  <script src="./script.js"></script>
  <script src="/socket.io/socket.io.js"></script>

<script src="/chatsocketio/loader.js"></script>
<script src="/chatia/loader.js"></script>
<script>
const formPropiedad = document.getElementById('formPropiedad');
const tbody = document.querySelector('#section-propiedades tbody');
const baseUrl = 'http://localhost:3000/api/propiedades';

// Función para cargar y mostrar propiedades en la tabla
async function cargarPropiedades() {
  try {
    const res = await fetch(baseUrl);
    const propiedades = await res.json();
    console.log('Propiedades recibidas:', propiedades);  // <-- aquí

    tbody.innerHTML = ''; // limpiar tabla

    propiedades.forEach(p => {
      // código para agregar fila
    });
  } catch (error) {
    console.error('Error cargando propiedades:', error);
  }
}


// Guardar o editar propiedad
formPropiedad.addEventListener('submit', async e => {
  e.preventDefault();

  const formData = new FormData(formPropiedad);
  const idEditar = formPropiedad.dataset.idEditar;

  try {
    if (idEditar) {
      // Editar propiedad (sin cambiar foto)
      const data = {
        direccion: formData.get('direccion'),
        tipo: formData.get('tipo'),
        precio: Number(formData.get('precio')),
        estado: 'Publicado' // o puedes mantener el estado actual si lo quieres
      };

      const res = await fetch(`${baseUrl}/${idEditar}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!res.ok) throw new Error('Error al editar propiedad');

      delete formPropiedad.dataset.idEditar;
      formPropiedad.querySelector('button[type="submit"]').textContent = 'Guardar Propiedad';
    } else {
      // Crear propiedad con foto (usamos FormData completo)
      const res = await fetch(baseUrl, {
        method: 'POST',
        body: formData
      });

      if (!res.ok) throw new Error('Error al crear propiedad');
    }

    formPropiedad.reset();
    cargarPropiedades();

  } catch (error) {
    console.error(error);
    alert('Error al guardar la propiedad.');
  }
});

// Delegar eventos para editar y eliminar desde la tabla
tbody.addEventListener('click', async e => {
  const tr = e.target.closest('tr');
  if (!tr) return;
  const id = tr.dataset.id;

  if (e.target.classList.contains('editar')) {
    try {
      // Obtener datos actuales de la propiedad para llenar el formulario
      const res = await fetch(`${baseUrl}/${id}`);
      if (!res.ok) throw new Error('No se pudo obtener la propiedad');
      const prop = await res.json();

      formPropiedad.dataset.idEditar = id;
      formPropiedad.direccion.value = prop.direccion;
      formPropiedad.tipo.value = prop.tipo;
      formPropiedad.precio.value = prop.precio;
      // Nota: No se puede prellenar input file, la foto permanece igual si no se cambia

      formPropiedad.querySelector('button[type="submit"]').textContent = 'Guardar Cambios';

    } catch (error) {
      console.error(error);
      alert('Error al cargar la propiedad para editar');
    }
  }

  if (e.target.classList.contains('eliminar')) {
    if (confirm('¿Estás seguro de eliminar esta propiedad?')) {
      try {
        const res = await fetch(`${baseUrl}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Error al eliminar');
        cargarPropiedades();
      } catch (error) {
        console.error(error);
        alert('Error al eliminar la propiedad');
      }
    }
  }
});
// dashboard.js

// API GET /api/clientes-agente/:agenteId
const clientes = await Usuario.find({ 
  rol: 'cliente', 
  agenteAsignado: req.params.agenteId 
});



// Carga inicial
cargarPropiedades();

</script>
<script src="js/dashboard.js"></script>
<script src="js/visita.js"></script>
<script src="js/contrato.js"></script>
</body>
</html>
